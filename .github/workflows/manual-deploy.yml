name: Manual Deploy (No Tests)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: shooter51/divestreams-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image (staging)
        if: ${{ github.event.inputs.environment == 'staging' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push Docker image (production)
        if: ${{ github.event.inputs.environment == 'production' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to staging VPS
        if: ${{ github.event.inputs.environment == 'staging' }}
        run: |
          echo "Deploying to staging (VPS 1271895)"
          curl -X POST \
            "https://developers.hostinger.com/api/vps/v1/virtual-machines/1271895/docker/divestreams-staging/update" \
            -H "Authorization: Bearer ${{ secrets.HOSTINGER_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --fail-with-body

      - name: Deploy to production VPS
        if: ${{ github.event.inputs.environment == 'production' }}
        run: |
          echo "Deploying to production (VPS 1239852)"
          curl -X POST \
            "https://developers.hostinger.com/api/vps/v1/virtual-machines/1239852/docker/divestreams-v2/update" \
            -H "Authorization: Bearer ${{ secrets.HOSTINGER_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --fail-with-body

      - name: Wait for deployment to stabilize
        run: sleep 45

      - name: Verify containers are running
        run: |
          if [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            VPS_ID=1271895
            PROJECT=divestreams-staging
          else
            VPS_ID=1239852
            PROJECT=divestreams-v2
          fi

          echo "Checking container status..."
          RESPONSE=$(curl -s -X GET \
            "https://developers.hostinger.com/api/vps/v1/virtual-machines/$VPS_ID/docker/$PROJECT/containers" \
            -H "Authorization: Bearer ${{ secrets.HOSTINGER_API_TOKEN }}" \
            -H "Content-Type: application/json")

          echo "$RESPONSE" | jq .

          RUNNING_COUNT=$(echo "$RESPONSE" | jq '[.[] | select(.state == "running")] | length')
          echo "Running containers: $RUNNING_COUNT"

          if [ "$RUNNING_COUNT" -lt 4 ]; then
            echo "ERROR: Expected 4 containers running, found $RUNNING_COUNT"
            exit 1
          fi

          echo "âœ… All 4 containers are running"

      - name: Deployment Summary
        run: |
          echo "### Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.environment }}" == "staging" ]; then
            echo "**URL:** https://staging.divestreams.com" >> $GITHUB_STEP_SUMMARY
          else
            echo "**URL:** https://divestreams.com" >> $GITHUB_STEP_SUMMARY
          fi
