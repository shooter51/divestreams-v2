name: Deploy Dev

# On push to develop: build + deploy to Dev VPS, then create PR to test.

on:
  push:
    branches: [develop]

concurrency:
  group: deploy-dev
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: shooter51/divestreams-app

jobs:
  build-deploy:
    runs-on: [self-hosted, linux, divestreams]
    environment: dev
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Dev VPS
        run: |
          echo "Deploying to Dev VPS (${{ vars.DEV_VPS_ID }})"
          curl -X POST \
            "https://developers.hostinger.com/api/vps/v1/virtual-machines/${{ vars.DEV_VPS_ID }}/docker/divestreams-dev/update" \
            -H "Authorization: Bearer ${{ secrets.HOSTINGER_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --fail

      - name: Wait for containers to start
        run: |
          EXPECTED=3
          VPS_ID=${{ vars.DEV_VPS_ID }}
          MAX_ATTEMPTS=12
          WAIT=10

          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Check $i/$MAX_ATTEMPTS..."
            RESPONSE=$(curl -s -X GET \
              "https://developers.hostinger.com/api/vps/v1/virtual-machines/${VPS_ID}/docker/divestreams-dev/containers" \
              -H "Authorization: Bearer ${{ secrets.HOSTINGER_API_TOKEN }}" \
              -H "Content-Type: application/json")
            RUNNING_COUNT=$(echo "$RESPONSE" | jq '[.[] | select(.state == "running")] | length')
            echo "  Running: $RUNNING_COUNT/$EXPECTED"

            if [ "$RUNNING_COUNT" -ge "$EXPECTED" ]; then
              echo "All containers running"
              exit 0
            fi

            if [ "$i" -eq "$MAX_ATTEMPTS" ]; then
              echo "ERROR: Expected $EXPECTED containers, found $RUNNING_COUNT after $((MAX_ATTEMPTS * WAIT))s"
              exit 1
            fi
            sleep $WAIT
          done

  create-test-pr:
    needs: build-deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Close existing develop→test PR if any
        run: |
          EXISTING=$(gh pr list --base test --head develop --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING" ]; then
            echo "Closing existing PR #$EXISTING"
            gh pr close "$EXISTING" --delete-branch=false
          fi
        env:
          GH_TOKEN: ${{ secrets.PROMOTION_PAT }}

      - name: Create PR develop→test
        run: |
          PR_URL=$(gh pr create \
            --base test \
            --head develop \
            --title "Promote develop → test" \
            --body "Auto-promotion from develop to test branch." \
            --label "auto-promotion")
          echo "Created PR: $PR_URL"

          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          gh pr merge "$PR_NUMBER" --auto --merge
        env:
          GH_TOKEN: ${{ secrets.PROMOTION_PAT }}
