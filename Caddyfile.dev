# Dev VPS - System-level Caddy configuration
# Routes *.dev.divestreams.com to Docker instances by subdomain.
# Updated dynamically by scripts/dev-instance.sh.
#
# Wildcard *.dev.divestreams.com catches tenant subdomains (demo.dev.divestreams.com)
# and routes them to the default instance (port 3001).
# Specific instance entries (e.g. default.dev.divestreams.com) take precedence.

{
    email admin@divestreams.com
    on_demand_tls {
        ask http://localhost:3001/api/health
    }
}

(security_headers) {
    header {
        X-Content-Type-Options nosniff
        Referrer-Policy strict-origin-when-cross-origin
        -Server
    }
}

# Landing page for dev.divestreams.com
dev.divestreams.com {
    import security_headers
    respond "DiveStreams Dev VPS - use <instance>.dev.divestreams.com" 200
}

# Wildcard catch-all for tenant subdomains (demo.dev.divestreams.com, admin.dev.divestreams.com, etc.)
# Routes to the default instance on port 3001
*.dev.divestreams.com {
    tls {
        on_demand
    }
    import security_headers
    reverse_proxy localhost:3001
}

# Instance routes â€” managed by dev-instance.sh
# BEGIN INSTANCES
default.dev.divestreams.com {
    import security_headers
    reverse_proxy localhost:3001
}
# END INSTANCES
