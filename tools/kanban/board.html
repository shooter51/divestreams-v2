<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DiveStreams Agent Kanban</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-card: #1c2128;
    --bg-card-hover: #242a33;
    --border: #30363d;
    --text-primary: #e6edf3;
    --text-secondary: #8b949e;
    --text-muted: #6e7681;
    --accent: #58a6ff;
    --p0: #f85149;
    --p1: #d29922;
    --p2: #58a6ff;
    --p3: #6e7681;
    --green: #3fb950;
    --purple: #bc8cff;
    --column-backlog: #6e7681;
    --column-progress: #d29922;
    --column-review: #bc8cff;
    --column-done: #3fb950;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: auto;
  }

  header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-logo {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--accent), var(--purple));
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
  }

  header h1 {
    font-size: 18px;
    font-weight: 600;
    letter-spacing: -0.3px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 2s ease-in-out infinite;
  }

  .status-dot.error {
    background: var(--p0);
    animation: none;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .last-updated {
    font-size: 12px;
    color: var(--text-muted);
  }

  .board {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    padding: 20px 24px;
    min-height: calc(100vh - 65px);
    align-content: start;
  }

  @media (max-width: 1200px) {
    .board {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 640px) {
    .board {
      grid-template-columns: 1fr;
    }
  }

  .column {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    min-height: 200px;
    max-height: calc(100vh - 105px);
  }

  .column-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .column-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 600;
  }

  .column-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .column-count {
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1px 8px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .column-body {
    padding: 12px;
    overflow-y: auto;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .column-body::-webkit-scrollbar {
    width: 6px;
  }

  .column-body::-webkit-scrollbar-track {
    background: transparent;
  }

  .column-body::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }

  .card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    cursor: default;
    transition: background 0.15s ease, border-color 0.15s ease, transform 0.15s ease, opacity 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .card:hover {
    background: var(--bg-card-hover);
    border-color: #444c56;
  }

  .card-enter {
    animation: cardSlideIn 0.35s ease-out;
  }

  @keyframes cardSlideIn {
    from {
      opacity: 0;
      transform: translateY(-10px) scale(0.97);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .card-move {
    animation: cardMove 0.4s ease-out;
  }

  @keyframes cardMove {
    0% {
      opacity: 0.5;
      transform: scale(0.95);
      box-shadow: 0 0 0 2px var(--accent);
    }
    100% {
      opacity: 1;
      transform: scale(1);
      box-shadow: 0 0 0 0px transparent;
    }
  }

  .priority-bar {
    position: absolute;
    top: 0;
    left: 0;
    width: 3px;
    height: 100%;
    border-radius: 3px 0 0 3px;
  }

  .priority-bar.P0 { background: var(--p0); }
  .priority-bar.P1 { background: var(--p1); }
  .priority-bar.P2 { background: var(--p2); }
  .priority-bar.P3 { background: var(--p3); }

  .card-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 6px;
  }

  .card-title {
    font-size: 13px;
    font-weight: 600;
    line-height: 1.4;
    color: var(--text-primary);
    flex: 1;
  }

  .priority-badge {
    font-size: 10px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 4px;
    flex-shrink: 0;
    letter-spacing: 0.3px;
  }

  .priority-badge.P0 { background: rgba(248,81,73,0.15); color: var(--p0); }
  .priority-badge.P1 { background: rgba(210,153,34,0.15); color: var(--p1); }
  .priority-badge.P2 { background: rgba(88,166,255,0.15); color: var(--p2); }
  .priority-badge.P3 { background: rgba(110,118,129,0.15); color: var(--p3); }

  .card-description {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 10px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 6px;
  }

  .card-meta-left {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-agent {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: var(--purple);
    background: rgba(188,140,255,0.1);
    padding: 2px 7px;
    border-radius: 4px;
  }

  .card-agent-icon {
    font-size: 10px;
  }

  .card-jira {
    font-size: 11px;
    color: var(--accent);
    text-decoration: none;
    background: rgba(88,166,255,0.1);
    padding: 2px 7px;
    border-radius: 4px;
    font-weight: 500;
  }

  .card-jira:hover {
    background: rgba(88,166,255,0.2);
  }

  .card-time {
    font-size: 11px;
    color: var(--text-muted);
  }

  .empty-column {
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    color: var(--text-muted);
    font-size: 13px;
    font-style: italic;
  }

  .error-banner {
    background: rgba(248,81,73,0.1);
    border: 1px solid rgba(248,81,73,0.3);
    color: var(--p0);
    padding: 10px 24px;
    font-size: 13px;
    text-align: center;
    display: none;
  }

  .error-banner.visible {
    display: block;
  }

  .summary-bar {
    display: flex;
    gap: 16px;
    align-items: center;
  }

  .summary-stat {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .summary-stat strong {
    color: var(--text-primary);
    font-weight: 600;
  }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="header-logo">DS</div>
    <h1>DiveStreams Agent Kanban</h1>
  </div>
  <div class="header-right">
    <div class="summary-bar" id="summary-bar"></div>
    <div class="status-indicator">
      <div class="status-dot" id="status-dot"></div>
      <span id="status-text">Live</span>
    </div>
    <div class="last-updated" id="last-updated">Loading...</div>
  </div>
</header>

<div class="error-banner" id="error-banner"></div>

<div class="board" id="board">
  <div class="column" id="col-backlog">
    <div class="column-header">
      <div class="column-title">
        <div class="column-dot" style="background: var(--column-backlog)"></div>
        Backlog
      </div>
      <span class="column-count" id="count-backlog">0</span>
    </div>
    <div class="column-body" id="body-backlog">
      <div class="empty-column">No tasks</div>
    </div>
  </div>

  <div class="column" id="col-in_progress">
    <div class="column-header">
      <div class="column-title">
        <div class="column-dot" style="background: var(--column-progress)"></div>
        In Progress
      </div>
      <span class="column-count" id="count-in_progress">0</span>
    </div>
    <div class="column-body" id="body-in_progress">
      <div class="empty-column">No tasks</div>
    </div>
  </div>

  <div class="column" id="col-in_review">
    <div class="column-header">
      <div class="column-title">
        <div class="column-dot" style="background: var(--column-review)"></div>
        In Review
      </div>
      <span class="column-count" id="count-in_review">0</span>
    </div>
    <div class="column-body" id="body-in_review">
      <div class="empty-column">No tasks</div>
    </div>
  </div>

  <div class="column" id="col-done">
    <div class="column-header">
      <div class="column-title">
        <div class="column-dot" style="background: var(--column-done)"></div>
        Done
      </div>
      <span class="column-count" id="count-done">0</span>
    </div>
    <div class="column-body" id="body-done">
      <div class="empty-column">No tasks</div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  const POLL_INTERVAL = 2000;
  const JIRA_BASE = 'https://divestreams.atlassian.net/browse/';
  const STATUSES = ['backlog', 'in_progress', 'in_review', 'done'];

  let previousData = null;
  let previousTaskMap = new Map();
  let fetchErrorCount = 0;

  function timeAgo(dateStr) {
    if (!dateStr) return '';
    const now = Date.now();
    const then = new Date(dateStr).getTime();
    const diff = now - then;
    if (diff < 0) return 'just now';
    const seconds = Math.floor(diff / 1000);
    if (seconds < 60) return seconds + 's ago';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return minutes + 'm ago';
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'h ago';
    const days = Math.floor(hours / 24);
    return days + 'd ago';
  }

  function formatTimestamp(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    return d.toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
  }

  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function createCardHtml(task, animationClass) {
    const desc = task.description
      ? '<div class="card-description">' + escapeHtml(task.description) + '</div>'
      : '';

    const agent = task.agent
      ? '<span class="card-agent"><span class="card-agent-icon">&#9679;</span>' + escapeHtml(task.agent) + '</span>'
      : '';

    const jira = task.jiraKey
      ? '<a class="card-jira" href="' + JIRA_BASE + escapeHtml(task.jiraKey) + '" target="_blank" rel="noopener">' + escapeHtml(task.jiraKey) + '</a>'
      : '';

    const priority = task.priority || 'P3';
    const updated = task.updated ? timeAgo(task.updated) : '';

    return '<div class="card ' + animationClass + '" data-id="' + escapeHtml(task.id) + '">' +
      '<div class="priority-bar ' + priority + '"></div>' +
      '<div class="card-top">' +
        '<div class="card-title">' + escapeHtml(task.title) + '</div>' +
        '<span class="priority-badge ' + priority + '">' + priority + '</span>' +
      '</div>' +
      desc +
      '<div class="card-meta">' +
        '<div class="card-meta-left">' + agent + jira + '</div>' +
        (updated ? '<span class="card-time">' + updated + '</span>' : '') +
      '</div>' +
    '</div>';
  }

  function renderBoard(data) {
    const tasksByStatus = {};
    STATUSES.forEach(function(s) { tasksByStatus[s] = []; });

    const newTaskMap = new Map();

    if (data.tasks && Array.isArray(data.tasks)) {
      data.tasks.forEach(function(task) {
        const status = STATUSES.includes(task.status) ? task.status : 'backlog';
        tasksByStatus[status].push(task);
        newTaskMap.set(task.id, task);
      });
    }

    STATUSES.forEach(function(status) {
      const body = document.getElementById('body-' + status);
      const countEl = document.getElementById('count-' + status);
      const tasks = tasksByStatus[status];

      countEl.textContent = tasks.length;

      if (tasks.length === 0) {
        body.innerHTML = '<div class="empty-column">No tasks</div>';
        return;
      }

      // Sort: P0 first, then P1, P2, P3; within same priority, most recently updated first
      const priorityOrder = { P0: 0, P1: 1, P2: 2, P3: 3 };
      tasks.sort(function(a, b) {
        const pa = priorityOrder[a.priority] !== undefined ? priorityOrder[a.priority] : 3;
        const pb = priorityOrder[b.priority] !== undefined ? priorityOrder[b.priority] : 3;
        if (pa !== pb) return pa - pb;
        const ua = a.updated ? new Date(a.updated).getTime() : 0;
        const ub = b.updated ? new Date(b.updated).getTime() : 0;
        return ub - ua;
      });

      let html = '';
      tasks.forEach(function(task) {
        let animClass = '';
        const prev = previousTaskMap.get(task.id);
        if (!prev) {
          animClass = 'card-enter';
        } else if (prev.status !== task.status || prev.updated !== task.updated) {
          animClass = 'card-move';
        }
        html += createCardHtml(task, animClass);
      });

      body.innerHTML = html;
    });

    // Update summary
    const total = data.tasks ? data.tasks.length : 0;
    const inProg = tasksByStatus['in_progress'].length;
    const done = tasksByStatus['done'].length;
    const summaryBar = document.getElementById('summary-bar');
    summaryBar.innerHTML =
      '<div class="summary-stat"><strong>' + total + '</strong> total</div>' +
      '<div class="summary-stat"><strong>' + inProg + '</strong> active</div>' +
      '<div class="summary-stat"><strong>' + done + '</strong> done</div>';

    // Update last-updated
    const lastUpdatedEl = document.getElementById('last-updated');
    if (data.lastUpdated) {
      lastUpdatedEl.textContent = 'Updated: ' + formatTimestamp(data.lastUpdated);
    } else {
      lastUpdatedEl.textContent = 'Updated: ' + formatTimestamp(new Date().toISOString());
    }

    previousTaskMap = newTaskMap;
    previousData = data;
  }

  function setError(msg) {
    const banner = document.getElementById('error-banner');
    const dot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    if (msg) {
      banner.textContent = msg;
      banner.classList.add('visible');
      dot.classList.add('error');
      statusText.textContent = 'Error';
    } else {
      banner.classList.remove('visible');
      dot.classList.remove('error');
      statusText.textContent = 'Live';
    }
  }

  function fetchAndRender() {
    fetch('tasks.json?t=' + Date.now())
      .then(function(response) {
        if (!response.ok) throw new Error('HTTP ' + response.status);
        return response.json();
      })
      .then(function(data) {
        fetchErrorCount = 0;
        setError(null);
        renderBoard(data);
      })
      .catch(function(err) {
        fetchErrorCount++;
        if (fetchErrorCount >= 3) {
          setError('Cannot load tasks.json -- ' + err.message + '. Make sure the server is running.');
        }
      });
  }

  // Initial load
  fetchAndRender();

  // Poll
  setInterval(fetchAndRender, POLL_INTERVAL);
})();
</script>
</body>
</html>
